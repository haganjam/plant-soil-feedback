---
title: "Power analysis"
format: 
  html:
    embed-resources: true
    math: mathjax
editor: source
execute:
  warning: false
---

## Experiment 1 {#sec-experiment-1}

For @sec-experiment-1, we are evaluating the statistical power of rejecting the following null hypothesis:

$H_0: \beta_7 = 0$
$H_A: \beta_7 \neq 0$

Based on the following model where:

  $B$ - Biomass (mg)

  $N$ - log(N mg) (standardised to minimum = 0)
  $M$ - 0 - microbes absent, 1 - microbes present
  $P$ - 0 - native, 1 - invasive

$$
log(B_{i}) = \alpha + \beta_1\text{N}_{i} + \beta_2\text{M}_{i} + \beta_3\text{P}_{i} + \beta_4\text{N}_{i}\text{M}_{i} + \beta_5\text{N}_{i}\text{P}_{i} + \beta_6\text{M}_{i}\text{P}_{i} + \beta_7\text{N}_{i}\text{M}_{i}\text{P}_{i} + \epsilon_{i}
$$ {#eq-exp1-lm}

$$
\epsilon_{i} \sim Normal(0, \sigma_{residual})
$$ {#eq-exp1-lm-error}

For the power analysis, we therefore need to obtain reasonable estimates for the different parameters in the model: $\alpha$, $\beta_1$, $\beta_2$, $\beta_3$, $\beta_4$, $\beta_5$, $\beta_6$, $\beta_7$ and $\sigma_{residual}$. Based on the hypothesised data generating process, these parameters are defined as follows:

$\alpha$ - expected $ln(B)$ when $N = 0$, $M = 0$, and $P = 0$

   By definition, when \(N=0\), \(M=0\), \(P=0\), all covariate terms vanish, so  
   $$
     \log(B)\big|_{N=0,\,M=0,\,P=0} 
     = \alpha + \varepsilon.
   $$  
   Hence  
   $$
     \alpha \;=\; \mathbb{E}\bigl[\log(B)\bigr]\big|_{N=0,\,M=0,\,P=0}.
   $$

$\beta_1$ - effect of $N$ when $M = 0$ and $P = 0$

Fix \(M=0,\,P=0\).  Then the model reduces to  
   $$
     \log(B)\big|_{M=0,\,P=0}
     = \alpha + \beta_{1}\,N + \varepsilon.
   $$  
   Therefore  
   $$
     \frac{\partial \log(B)}{\partial N}
     \Bigg|_{M=0,\,P=0}
     = \beta_{1}.
   $$  
   In other words, \(\beta_{1}\) is exactly the slope of \(\log(B)\) with respect to \(N\), evaluated at \(M=0\) and \(P=0\).

$\beta_2$ - effect of $M$ when $N = 0$ and $P = 0$

Because \(M\) is binary, one writes the change in \(\log(B)\) as  
   $$
     \log(B)\big|_{N=0,\,P=0,\,M=1}
     - \log(B)\big|_{N=0,\,P=0,\,M=0}
     = \beta_{2}.
   $$  
   Equivalently, as a finite difference:  
   $$
     \frac{\Delta \log(B)}{\Delta M}\Bigg|_{N=0,\,P=0}
     = \beta_{2}.
   $$  
   Thus \(\beta_{2}\) is the increment in \(\log(B)\) when \(M\) flips from 0→1, holding \(N=0\) and \(P=0\).

$\beta_3$ - effect of $P$ when $N = 0$ and $M = 0$

Similarly, since \(P\) is binary,  
   $$
     \log(B)\big|_{N=0,\,M=0,\,P=1}
     - \log(B)\big|_{N=0,\,M=0,\,P=0}
     = \beta_{3}.
   $$  
   Equivalently,  
   $$
     \frac{\Delta \log(B)}{\Delta P}
     \Bigg|_{N=0,\,M=0}
     = \beta_{3}.
   $$  
   Hence \(\beta_{3}\) is the jump in \(\log(B)\) when \(P\) switches from 0→1, at \(N=0,\,M=0\).

$\beta_4$ - additional effect of $N$ with microbes $M = 1$

Fix \(P=0\).  Then  
   $$
     \log(B)\big|_{P=0}
     = \alpha + \beta_{1}\,N 
       + \beta_{2}\,M 
       + \beta_{4}\,(N\,M) 
       + \varepsilon.
   $$  
   - If \(M=0\), the \(N\)-term is \(\beta_{1}N\).  
   - If \(M=1\), the \(N\)-term is \(\beta_{1}N + \beta_{4}N = (\beta_{1}+\beta_{4})\,N.\)

   Thus, at \(P=0\):  
   $$
     \frac{\partial \log(B)}{\partial N}
     \Bigg|_{M=0,\,P=0}
     = \beta_{1}, 
     \qquad
     \frac{\partial \log(B)}{\partial N}
     \Bigg|_{M=1,\,P=0}
     = \beta_{1} + \beta_{4}.
   $$  
   Therefore  
   $$
     \beta_{4} 
     = 
     \biggl[
       \frac{\partial \log(B)}{\partial N}\Big|_{M=1,\,P=0}
       - 
       \frac{\partial \log(B)}{\partial N}\Big|_{M=0,\,P=0}
     \biggr].
   $$  
   In words, \(\beta_{4}\) is the extra \(N\)-effect when microbes (\(M=1\)) are present, with \(P=0\).

$\beta_5$ - additional effect of $N$ for invasives $P = 1$

Fix \(M=0\).  Then  
   $$
     \log(B)\big|_{M=0}
     = \alpha + \beta_{1}\,N 
       + \beta_{3}\,P 
       + \beta_{5}\,(N\,P)
       + \varepsilon.
   $$  
   - If \(P=0\), the \(N\)-term is \(\beta_{1}N\).  
   - If \(P=1\), the \(N\)-term is \(\beta_{1}N + \beta_{5}N = (\beta_{1}+\beta_{5})\,N.\)

   Hence, at \(M=0\):  
   $$
     \frac{\partial \log(B)}{\partial N}
     \Bigg|_{M=0,\,P=0}
     = \beta_{1}, 
     \qquad
     \frac{\partial \log(B)}{\partial N}
     \Bigg|_{M=0,\,P=1}
     = \beta_{1} + \beta_{5}.
   $$  
   It follows that  
   $$
     \beta_{5}
     = 
     \biggl[
       \frac{\partial \log(B)}{\partial N}\Big|_{M=0,\,P=1}
       - 
       \frac{\partial \log(B)}{\partial N}\Big|_{M=0,\,P=0}
     \biggr].
   $$  
   Thus \(\beta_{5}\) is the additional effect of \(N\) in invasive plants (\(P=1\)), when microbes are absent (\(M=0\)).

$\beta_6$ - additional effect of $M$ for invasives $P = 1$

Fix \(N=0\).  Then  
   $$
     \log(B)\big|_{N=0}
     = \alpha 
       + \beta_{2}\,M 
       + \beta_{3}\,P 
       + \beta_{6}\,(M\,P)
       + \varepsilon.
   $$  
   - If \(P=0\), changing \(M\) from 0→1 adds \(\beta_{2}\).  
   - If \(P=1\), changing \(M\) from 0→1 adds \(\beta_{2} + \beta_{6}\).

   Hence, at \(N=0\):  
   $$
     \frac{\Delta \log(B)}{\Delta M}
     \Bigg|_{N=0,\,P=0}
     = \beta_{2}, 
     \qquad
     \frac{\Delta \log(B)}{\Delta M}
     \Bigg|_{N=0,\,P=1}
     = \beta_{2} + \beta_{6}.
   $$  
   Consequently,  
   $$
     \beta_{6}
     = 
     \biggl[
       \frac{\Delta \log(B)}{\Delta M}\Big|_{N=0,\,P=1}
       - 
       \frac{\Delta \log(B)}{\Delta M}\Big|_{N=0,\,P=0}
     \biggr].
   $$  
   In plain terms, \(\beta_{6}\) is the extra effect of microbes (\(M\)) when the plant is invasive (\(P=1\)), at \(N=0\).

$\beta_7$ - additional effect of $N$ with microbes $M = 1$ for invasives $P = 1$

When \(M=1\) and \(P=1\), the full “\(N\)-slope” picks up all main and two‐way interaction pieces.  In particular,  
   $$
     \log(B)\big|_{M=1,\,P=1}
     = \alpha 
       + \beta_{1}\,N 
       + \beta_{2} 
       + \beta_{3} 
       + \beta_{4}\,N 
       + \beta_{5}\,N 
       + \beta_{6} 
       + \beta_{7}\,N 
       + \varepsilon.
   $$  
   Collecting the terms that multiply \(N\):  
   $$
     (\beta_{1} + \beta_{4} + \beta_{5} + \beta_{7})\,N.
   $$  
   Hence, in the “invasive + microbes” cell \((M=1,\,P=1)\),  
   $$
     \frac{\partial \log(B)}{\partial N}
     \Bigg|_{M=1,\,P=1}
     = \beta_{1} + \beta_{4} + \beta_{5} + \beta_{7}.
   $$  
   Therefore  
   $$
     \beta_{7}
     = 
     \biggl[
       \frac{\partial \log(B)}{\partial N}\Big|_{M=1,\,P=1}
       - (\beta_{1} + \beta_{4} + \beta_{5})
     \biggr].
   $$

$\sigma_{residual}$ - residual standard deviation

We used previous literature and some *unpublished* experimental data to assign realist parameter values for the power analysis. $\alpha$ represents the mean native plant biomass (L) on the log-scale without microbes, for the lowest level of nitrogen (4 mg). Previous work with these native species indicates that 2.5 g is reasonable for the dry-weight of these plants without microbes and at low nitrogen values (e.g. Goossens et al. 2023, *npj biodiversity*). For the effect of nitrogen (N), $\beta_1$, we used estimates from Minden and Olde Venterinck (2019, *Functional Ecology*) where, for these native species, an increase of between 0 and 15% per log-unit of nitrogen was measured. The effect of plant-soil feedbacks (i.e. microbes, M) on native species, $\beta_2$, was taken from Schitzer et al. (2011, *Ecology*) who measured a reduction of plant biomass of between 10 and 40% due to the presence of microbes. Pilot data indicated a difference between natives and invasives that is between -10% and 30% (i.e. invasives have slightly less biomass or more biomass). For the interactions, we varied the strength between -10% and 10% which is also based on analysing pilot data. We estimated $\sigma_{residual}$ based on data from a previous, unpublished experiment on the same species. 

Using these estimates, we set-up the parameter ranges to simulate and wrap into a data.frame:

```{r}
# convert percentage to parameter for the log-scale
par_target <- function(target) log(1 + target)

alpha <- log(2.5)
beta1 <- par_target(c(0.05, 0.10, 0.15))
beta2 <- par_target(seq(0.10, 0.40, 0.10))
beta3 <- par_target(seq(-0.10, 0.30, 0.10))
beta4 <- par_target(seq(-0.10, 0.10, 0.10))
beta5 <- par_target(seq(-0.10, 0.10, 0.10))
beta6 <- par_target(seq(-0.10, 0.10, 0.10))
beta7_ha <- par_target(seq(0.10, 0.30, 0.10))

sigma_residual <- 0.10

# in addition, we set the number of replicates
n_rep <- seq(2, 5, 1)

# wrap into a simulation grid
exp1_sim_grid <- tidyr::expand_grid(n_rep,
                                    alpha, beta1, beta2, beta3,
                                    beta4, beta5, beta6,
                                    beta7_ha,
                                    sigma_residual)

# check the data
exp1_sim_grid
```

Next, we load the function used to simulate power analysis for a single set of parameters and test the function for a set of parameters.

```{r}
# load the code for simulation experiment 1
source(here::here("functions/sim_power_exp1.R"))

# run the power analysis
power_exp1_test <- 
  sim_power_exp1(
    n_sim = 1000,
    alpha_rej = 0.05,
    n_rep = 3,                  
    sigma_residual = 0.10,        
    N_vals = log(c(4, 8, 16, 32, 64)),
    M_vals = c(0, 1),
    P_vals = c(0, 1),              
    alpha = 1.5,                  
    beta1 = 0.2,                  
    beta2 = -0.12,
    beta3 = 0.05,
    beta4 = 0.05,
    beta5 = 0.05,
    beta6 = 0.05,
    beta7_h0 = 0,
    beta7_ha = 0.10)

# print the results
power_exp1_test
```

Now we run the power analysis 

```{r}
# Load required package
library(parallel)
library(dplyr)

# Define number of cores
n_cores <- 4

# Parallelised loop
power_exp1 <- mclapply(seq_len(nrow(exp1_sim_grid)), mc.cores = n_cores, function(i) {
  
  # print the iteration
  print(i)
  
  # Get the input parameters
  input_pars <- exp1_sim_grid[i, ]
  
  # Run the simulation
  power_x <- sim_power_exp1(
    n_sim = 100,
    alpha_rej = 0.05,
    n_rep = input_pars$n_rep,                   
    sigma_residual = input_pars$sigma_residual,        
    N_vals = log(c(4, 8, 16, 32, 64)),
    M_vals = c(0, 1),
    P_vals = c(0, 1),              
    alpha = input_pars$alpha,                  
    beta1 = input_pars$beta1,                  
    beta2 = input_pars$beta2,
    beta3 = input_pars$beta3,
    beta4 = input_pars$beta4,
    beta5 = input_pars$beta5,
    beta6 = input_pars$beta6,
    beta7_h0 = 0,
    beta7_ha = input_pars$beta7_ha
  )
  
  # Return results
  tibble(
    run = i,
    type_1_error = power_x$type_I_error_rate,
    type_2_error = power_x$type_II_error_rate,
    power = power_x$power
  )
})

# bind into a data.frame
power_exp1 <- dplyr::bind_rows(power_exp1)
head(power_exp1)
```

```{r}
# bind to the parameter data
power_exp1 <- dplyr::bind_cols(exp1_sim_grid, power_exp1)

# print the first few rows
head(power_exp1)

# summarise the data for plotting
power_exp1$beta7_ha_char <- paste0((exp(power_exp1$beta7_ha) - 1)*100, "%")

# summarise the data
power_exp1_sum <-
  power_exp1 |>
  dplyr::group_by(sigma_residual, beta7_ha_char, n_rep) |>
  dplyr::summarise(power_med = median(power),
                   quantile_low = quantile(power, 0.10),
                   quantile_high = quantile(power, 0.90))

# plot the data
ggplot(data = power_exp1_sum ,
       mapping = aes(x = n_rep, y = power_med, colour = beta7_ha_char)) +
  geom_ribbon(mapping = aes(x = n_rep, 
                            ymin = quantile_low, ymax = quantile_high,
                            colour = beta7_ha_char),
                width = 0) +
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0.50, linetype = "dashed") +
  facet_wrap(~sigma_residual) +
  theme_minimal()
```




